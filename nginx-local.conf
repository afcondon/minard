# Minard Local Reverse Proxy
#
# Routes:
#   /code/api/*  -> minard-backend:3000/api/*
#   /code/data/* -> minard-backend:3000/data/*
#   /code/*      -> minard-frontend:80/code/*

upstream backend {
    server minard-backend:3000;
}

upstream frontend {
    server minard-frontend:80;
}

server {
    listen 80;
    server_name localhost;

    # API routes -> backend (strip /code prefix)
    location /code/api/ {
        proxy_pass http://backend/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Legacy data routes -> backend (strip /code prefix)
    location /code/data/ {
        proxy_pass http://backend/data/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Health check -> backend
    location /code/health {
        proxy_pass http://backend/health;
    }

    # Static files -> frontend (keep /code prefix)
    location /code/ {
        proxy_pass http://frontend/code/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Root redirect to /code/ (preserve host and port)
    location = / {
        return 302 $scheme://$http_host/code/;
    }
}
